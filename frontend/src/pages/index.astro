---
import Layout from "~/layouts/Layout.astro";
import Card from "~/components/Card.astro";
import AnimatedSection from "~/components/AnimatedSection.astro";
import HeroBanner from "~/components/HeroBanner.astro";
import Sidebar from "~/components/Sidebar.astro";
import Pagination from "~/components/Pagination.astro";
import { loadQuery } from "~/lib/load-query";
import type { SanityDocument } from "@sanity/client";

// Force server-side rendering - don't prerender this page
export const prerender = false;

const postsPerPage = 4;
const pageParam = Astro.url.searchParams.get("page");
const currentPage = pageParam ? parseInt(pageParam, 10) : 1;

// Get total count
const { data: totalCount } = await loadQuery<number>({
  query: `count(*[_type == "post"])`,
});

const totalPages = Math.ceil((totalCount || 0) / postsPerPage);

// Validate current page and redirect if invalid
if (currentPage < 1 || (totalPages > 0 && currentPage > totalPages)) {
  return Astro.redirect("/");
}

const validPage = currentPage;

// Calculate offset - GROQ uses inclusive ranges [start..end]
const offset = (validPage - 1) * postsPerPage;
const limit = offset + postsPerPage - 1;

// Fetch posts for current page
const { data: currentPagePosts } = await loadQuery<SanityDocument[]>({
  query: `*[_type == "post"] | order(publishedAt desc) [${offset}..${limit}] {
    _id,
    title,
    slug,
    excerpt,
    publishedAt,
    "imageUrl": mainImage.asset->url
  }`,
});
---

<Layout title="Blank.428 - Con dốc nhạt nhoà">
  <AnimatedSection animation="fade-in" duration={0.8}>
    <HeroBanner 
      title="Blank.428"
      subtitle="Con dốc nhạt nhoà"
    />
  </AnimatedSection>
  <div class="home-container">
    <div class="content-layout">
      <div class="main-content">
        <section class="posts-section">
          {currentPagePosts && currentPagePosts.length > 0 ? (
            <div class="posts-list">
              {currentPagePosts.map((post, index) => (
                <AnimatedSection 
                  animation="fade-up" 
                  delay={0.1 * (index + 1)}
                >
                  <Card
                    title={post.title}
                    excerpt={post.excerpt}
                    date={post.publishedAt}
                    href={`/posts/${post.slug.current}`}
                    image={post.imageUrl}
                    index={index}
                  />
                </AnimatedSection>
              ))}
            </div>
          ) : (
            <AnimatedSection animation="fade-in" delay={0.3}>
              <div class="no-posts">
                <p>No posts found for this page.</p>
              </div>
            </AnimatedSection>
          )}

          {totalPages && totalPages > 1 && (
            <div class="pagination-container">
              <AnimatedSection animation="fade-up" delay={0.5}>
                <Pagination 
                  currentPage={validPage}
                  totalPages={totalPages}
                  baseUrl="/"
                />
              </AnimatedSection>
            </div>
          )}
        </section>
      </div>

      <div class="sidebar-wrapper">
        <AnimatedSection animation="fade-in" delay={0.3}>
          <Sidebar />
        </AnimatedSection>
      </div>
    </div>
  </div>
</Layout>

<style>
  .home-container {
    max-width: var(--content-max-width);
    margin: 0 auto;
    padding: 0 1rem;
    margin-top: -400px;
    position: relative;
    z-index: 10;
  }

  @media (max-width: 768px) {
    .home-container {
      margin-top: -450px;
      padding: 0;
    }
  }

  .content-layout {
    display: flex;
    gap: 2rem;
    align-items: flex-start;
    margin-top: 0;
    position: relative;
    z-index: 10;
  }

  @media (max-width: 1200px) {
    .content-layout {
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .sidebar-wrapper {
      display: none;
    }
  }

  @media (max-width: 768px) {
    .content-layout {
      gap: 1.5rem;
      padding: 0 0.75rem;
    }
  }

  .main-content {
    flex: 1;
    min-width: 0;
    width: 100%;
  }

  @media (max-width: 1200px) {
    .main-content {
      max-width: 800px;
      margin: 0 auto;
    }
  }

  .posts-section {
    margin-bottom: 2rem;
  }

  .pagination-container {
    display: flex;
    justify-content: center;
    margin-top: 2rem;
  }

  .section-title {
    font-size: 2rem;
    margin-bottom: 2rem;
    position: relative;
    padding-bottom: 1rem;
  }

  .section-title::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 60px;
    height: 4px;
    background: linear-gradient(90deg, var(--red-1), var(--red-2));
    border-radius: 2px;
    box-shadow: var(--shadow-red-6-shadow);
  }

  .posts-list {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .no-posts {
    text-align: center;
    padding: 3rem;
    background: var(--color-wrap);
    border-radius: 12px;
    box-shadow: var(--shadow-card);
  }

  .no-posts p {
    color: var(--grey-9);
    font-size: 1.1rem;
    margin: 0;
  }

  @media (max-width: 768px) {
    .home-container {
      padding: 0;
    }

    .content-layout {
      gap: 1.5rem;
      padding: 0 0.75rem;
    }

    .section-title {
      font-size: 1.75rem;
      padding: 0 0.75rem;
    }

    .posts-list {
      gap: 1.5rem;
      padding: 0 0.75rem;
    }
  }

  @media (max-width: 480px) {
    .section-title {
      font-size: 1.5rem;
    }
  }
</style>